---
import { Icon } from "astro-icon/components";
import MaamiConfig from "../../maami.config";
import I18nKeys from "../locales/keys";
import { i18n } from "../locales/translation";
import SocialIcon from "./widgets/SocialIcon.astro";
import SiteViews from "./SiteViews.jsx";

// 1. FIREBASE IMPORTS
import { db } from '../lib/firebase';
import { collection, getDocs, query, orderBy, limit } from 'firebase/firestore';

interface Props {
  allPosts?: any[]; 
  allRoutes?: any[]; // Added this prop
}

const { allPosts: initialPosts, allRoutes: initialRoutes } = Astro.props;

// 2. SMART DATA LOGIC
let postsData = initialPosts;
let routesData = initialRoutes;

// Auto-fetch if data isn't passed (for static pages like About)
if (!postsData) {
  try {
    const q = query(collection(db, "blog"), orderBy("published", "desc"), limit(20));
    const querySnapshot = await getDocs(q);
    postsData = querySnapshot.docs.map(doc => doc.data());
  } catch (e) {
    postsData = [];
  }
}

if (!routesData) {
  try {
    const q = query(collection(db, "route"), limit(10));
    const querySnapshot = await getDocs(q);
    routesData = querySnapshot.docs.map(doc => doc.data());
  } catch (e) {
    routesData = [];
  }
}

// 3. UTILITY: SLUGIFY
const slugify = (text: string) => {
  return text.toString().toLowerCase().trim()
    .replace(/\s+/g, '-').replace(/[^\w\-]+/g, '').replace(/\-\-+/g, '-');
};

// 4. AGGREGATE DATA (Merged logic for Posts and Routes)
const categories = new Map();
const tags = new Map();

// Helper to process items
const processItem = (item: any) => {
  if (!item) return;

  // Categories
  if (item.category) {
    const catList = Array.isArray(item.category) ? item.category : [item.category];
    catList.forEach((cat) => {
      const catName = String(cat || "").trim();
      if (!catName) return;
      const catSlug = slugify(catName);
      if (!categories.has(catSlug)) categories.set(catSlug, { name: catName, count: 0 });
      categories.get(catSlug).count++;
    });
  }

  // Tags
  if (item.tags && Array.isArray(item.tags)) {
    item.tags.forEach((t) => {
      const tagName = String(t || "").trim();
      if (!tagName) return;
      const tagSlug = slugify(tagName);
      if (!tags.has(tagSlug)) tags.set(tagSlug, { name: tagName, count: 0 });
      tags.get(tagSlug).count++;
    });
  }
};

postsData?.forEach(processItem);
routesData?.forEach(processItem);

const categoryKeys = [...categories.keys()].sort();
const tagKeys = [...tags.keys()].sort();
---

<span class="rounded-md bg-[var(--primary-color-lighten)] px-2.5 py-0.5 text-[var(--primary-color)]">
  {categories.get(categorySlug).count}
</span>
