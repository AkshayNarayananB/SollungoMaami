---
import { Icon } from "astro-icon/components";
import MaamiConfig from "../../maami.config";
import I18nKeys from "../locales/keys";
import { i18n } from "../locales/translation";
import SocialIcon from "./widgets/SocialIcon.astro";
import SiteViews from "./SiteViews.jsx";
import { db } from '../lib/firebase';
import { collection, getDocs, query, orderBy, limit } from 'firebase/firestore';

interface Props {
  allPosts?: any[]; 
  allRoutes?: any[]; 
}

const { allPosts: initialPosts, allRoutes: initialRoutes } = Astro.props;

// 1. DATA FETCHING (Fallback for static pages)
let postsData = initialPosts;
let routesData = initialRoutes;

if (!postsData) {
  try {
    const q = query(collection(db, "blog"), orderBy("published", "desc"), limit(20));
    const querySnapshot = await getDocs(q);
    postsData = querySnapshot.docs.map(doc => doc.data());
  } catch (e) { postsData = []; }
}

if (!routesData) {
  try {
    const querySnapshot = await getDocs(collection(db, "route"), limit(10));
    routesData = querySnapshot.docs.map(doc => doc.data());
  } catch (e) { routesData = []; }
}

// 2. UTILITIES
const slugify = (text: string) => {
  return text.toString().toLowerCase().trim()
    .replace(/\s+/g, '-').replace(/[^\w\-]+/g, '').replace(/\-\-+/g, '-');
};

const categories = new Map();
const tags = new Map();

// 3. AGGREGATE BLOG CATEGORIES (Only from Posts)
postsData?.forEach((data) => {
  if (data.category) {
    const catList = Array.isArray(data.category) ? data.category : [data.category];
    catList.forEach((cat) => {
      const name = String(cat || "").trim();
      if (!name) return;
      const slug = slugify(name);
      if (!categories.has(slug)) categories.set(slug, { name, count: 0 });
      categories.get(slug).count++;
    });
  }
});

// 4. AGGREGATE TAGS (From both Posts and Routes)
const processTags = (item: any) => {
  if (item?.tags && Array.isArray(item.tags)) {
    item.tags.forEach((t: string) => {
      const name = String(t || "").trim();
      if (!name) return;
      const slug = slugify(name);
      if (!tags.has(slug)) tags.set(slug, { name, count: 0 });
      tags.get(slug).count++;
    });
  }
};

postsData?.forEach(processTags);
routesData?.forEach(processTags);

// 5. CONVERT TO ARRAYS FOR RENDERING (Fixes the "undefined" variable errors)
const categoryList = Array.from(categories.entries()).map(([slug, val]) => ({ slug, ...val }))
  .sort((a, b) => b.count - a.count);

const tagList = Array.from(tags.entries()).map(([slug, val]) => ({ slug, ...val }))
  .sort((a, b) => b.count - a.count);
---

<div class="flex w-full flex-row justify-center">
  <div class="flex flex-col space-y-3">
    
    <div class="onload-animation rounded-3xl bg-[var(--card-color)] p-3">
      <a href="/about" class="avatar-wrapper">
        <img src={MaamiConfig.avatarUrl} alt="avatar" class="avatar lozad select-none" />
      </a>
      <div class="username mt-4 text-center">
        <p>{MaamiConfig.username}</p>
        <div class="mx-auto mt-1 h-1 w-8 rounded-full bg-[var(--primary-color)]"></div>
      </div>
      <p class="slogan mt-2 text-center text-[var(--text-color-lighten)] text-sm italic">
        {MaamiConfig.sign}
      </p>
      <SiteViews client:only="react" />
      <div class="mt-2 flex flex-wrap justify-center gap-2">
        {MaamiConfig.socialLinks.map((item) => (
          <SocialIcon name={item.icon} link={item.link} />
        ))}
      </div>
    </div>

    {categoryList.length > 0 && (
      <div class="onload-animation space-y-2 rounded-3xl bg-[var(--card-color)] p-3">
        <div class="title m-[0.375rem] flex items-center">
          <a href="/categories/" class="pl-4 text-xl font-bold text-[var(--text-color)] hover:text-[var(--primary-color)] transition-colors">
            {i18n(I18nKeys.side_bar_categories)}
          </a>
        </div>
        <div class="flex flex-col">
          {categoryList.slice(0, MaamiConfig.maxSidebarCategoryChip).map((cat) => (
            <a href={`/categories/${cat.slug}`} class="flex items-center justify-between rounded-lg px-3 py-2 hover:bg-[var(--primary-color-lighten)] group transition-all">
              <p class="text-[var(--text-color)] group-hover:text-[var(--primary-color)] transition-all">{cat.name}</p>
              <span class="rounded-md bg-[var(--primary-color-lighten)] px-2.5 py-0.5 text-[var(--primary-color)] text-xs">{cat.count}</span>
            </a>
          ))}
        </div>
      </div>
    )}

    {tagList.length > 0 && (
      <div class="onload-animation space-y-2 rounded-3xl bg-[var(--card-color)] p-3">
        <div class="title m-[0.375rem] flex items-center">
          <a href="/tags/" class="pl-4 text-xl font-bold text-[var(--text-color)] hover:text-[var(--primary-color)] transition-colors">
            {i18n(I18nKeys.side_bar_tags)}
          </a>
        </div>
        <div class="flex flex-wrap gap-2 p-1">
          {tagList.slice(0, MaamiConfig.maxSidebarTagChip).map((tag) => (
            <a href={`/tags/${tag.slug}`} class="grow text-center rounded-md bg-[var(--primary-color-lighten)] px-2 py-1 text-sm text-[var(--primary-color)] hover:brightness-90 transition-all">
              {tag.name}
            </a>
          ))}
        </div>
      </div>
    )}
  </div>
</div>

<style>
  /* Keep your existing styles here */
  .avatar { @apply h-56 w-56 rounded-xl object-cover; }
  .title { position: relative; }
  .title::before {
    content: ""; position: absolute; left: 0; top: 4px; bottom: 4px;
    width: 4px; @apply bg-[var(--primary-color)] rounded-full;
  }
</style>
