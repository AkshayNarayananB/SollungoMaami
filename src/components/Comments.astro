// src/components/Comments.astro
const { slug } = Astro.props;
import { db } from "../db/firebase";
import { collection, addDoc, query, orderBy, onSnapshot } from "firebase/firestore";
---

<section class="comments-section">
Â  <h2 class="text-xl font-bold mb-4">Comments</h2>
Â  <div id="comments-list" class="space-y-4"></div>

Â  <h3 class="text-lg font-semibold mt-6">Leave a Comment</h3>
  Â  <form id="comment-form" class="space-y-2" data-slug={slug}>
Â  Â  <textarea name="comment" placeholder="Write your comment..." required class="w-full p-2 rounded border"></textarea>
Â  Â  <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">Submit</button>
Â  </form>
</section>

<script is:client>
  // Access the form element and retrieve the slug from its data attribute
  const form = document.querySelector("#comment-form");
  const slug = form.dataset.slug;

  if (form) {
    const commentsList = document.querySelector("#comments-list");
    const commentsRef = collection(db, "comments_" + slug);

    // Real-time listener
    const q = query(commentsRef, orderBy("timestamp", "asc"));
    onSnapshot(q, (snapshot) => {
      commentsList.innerHTML = "";
      snapshot.forEach(doc => {
        const data = doc.data();
        const div = document.createElement("div");
        div.className = "p-3 bg-gray-100 rounded";
        div.innerHTML = `<p>${data.comment}</p>`;
        commentsList.appendChild(div);
      });
    });

    // Bind submit after form exists
    form.addEventListener("submit", async (e) => {
      e.preventDefault(); // âœ… stop reload
      const val = form.comment.value.trim();
      if (!val) return;

      try {
        await addDoc(commentsRef, {
          comment: val,
          timestamp: new Date()
        });
        form.reset();
      } catch (err) {
        console.error("ðŸ”¥ Firestore error:", err);
      }
    });
  }
</script>
