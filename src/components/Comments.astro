---
// src/components/Comments.astro
const { slug } = Astro.props;
import { db } from '../db/firebase';
import {
  collection,
  addDoc,
  query,
  orderBy,
  onSnapshot
} from 'firebase/firestore';
---
<section id="comments-section" class="comments-section" data-slug={slug}>
  <h2 class="text-xl font-bold mb-4">Comments</h2>
  <div id="comments-list" class="space-y-4"></div>

  <h3 class="text-lg font-semibold mt-6">Leave a Comment</h3>
  <form id="comment-form" class="space-y-2">
    <textarea
      name="comment"
      placeholder="Write your comment..."
      required
      class="w-full p-2 rounded border"
    ></textarea>
    <button type="submit" class="bg-blue-600 text-white px-4 py-2 rounded">
      Submit
    </button>
  </form>
</section>

<script is:client>
import { db } from '../db/firebase';
import { collection, addDoc, query, orderBy, onSnapshot } from 'firebase/firestore';

// Get slug from the data attribute
const section = document.getElementById('comments-section');
const slug = section.dataset.slug;
const commentsList = document.getElementById('comments-list');
const form = document.getElementById('comment-form');

// Reference to the collection for this post
const commentsRef = collection(db, 'comments_' + slug);

// Real-time listener for comments
const q = query(commentsRef, orderBy('timestamp', 'asc'));
onSnapshot(q, (snapshot) => {
  commentsList.innerHTML = '';
  snapshot.forEach(doc => {
    const data = doc.data();
    const div = document.createElement('div');
    div.className = 'p-3 bg-gray-100 rounded';
    div.innerHTML = `<p>${data.comment}</p>`;
    commentsList.appendChild(div);
  });
});

// Handle new comment submission
form.addEventListener('submit', async (e) => {
  e.preventDefault(); // Prevent default form submission

  const comment = form.comment.value.trim();
  if (!comment) return;

  try {
    await addDoc(commentsRef, {
      comment,
      timestamp: new Date()
    });
    form.reset(); // Clear textarea
  } catch (err) {
    console.error('Error adding comment:', err);
    alert('Failed to submit comment. Check console for details.');
  }
});
</script>
