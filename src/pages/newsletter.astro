---
export const prerender = false;

import Main from "../layouts/MainLayout.astro";
import { db } from "../lib/firebase";
import { collection, getDocs, doc, getDoc, query, orderBy, limit } from "firebase/firestore";

let meta = null;
let spotlightPosts = [];
let archives = [];

try {
  const metaRef = doc(db, "newsletter_metadata", "latest");
  const metaSnap = await getDoc(metaRef);
  
  if (metaSnap.exists()) {
    meta = metaSnap.data();
    const spotlightSlugs = meta.spotlight_slugs || [];

    for (const slug of spotlightSlugs) {
        const postRef = doc(db, "blog", slug.trim());
        const postSnap = await getDoc(postRef);
        if (postSnap.exists()) {
            spotlightPosts.push({ id: postSnap.id, ...postSnap.data() });
        }
    }

    const blogQuery = query(collection(db, "blog"), orderBy("published", "desc"), limit(15));
    const blogSnap = await getDocs(blogQuery);
    const allBlogs = blogSnap.docs.map(d => ({ id: d.id, ...d.data() }));
    archives = allBlogs
        .filter(post => !spotlightSlugs.includes(post.id))
        .slice(0, 5);
  }
} catch (e) {
  console.error("Newsletter Fetch Error:", e);
}
---

<Main title="Maami's Digest">
  <div class="newsletter-container max-w-4xl mx-auto px-4 py-6 md:py-10" data-pagefind-ignore>
    
    {meta && (
      <>
        <header class="border-b-2 border-[var(--primary-color-lighten)] pb-6 md:pb-10 mb-8 md:mb-12 flex justify-between items-center overflow-hidden">
          <div class="min-w-0 flex-1">
            <h1 class="text-5xl md:text-7xl font-black text-[var(--primary-color)] leading-none tracking-tight">MAAMI'S</h1>
            <h2 class="text-2xl md:text-4xl font-bold text-[var(--text-color)] tracking-[0.1em] md:tracking-[0.2em] opacity-90">DIGEST</h2>
            
            <div class="mt-3 text-[9px] md:text-[11px] font-black tracking-widest uppercase flex items-center gap-2 text-[var(--text-color)] opacity-60">
                <a 
                  href="https://www.instagram.com/sollungomaamiofficial/" 
                  target="_blank" 
                  rel="noopener noreferrer" 
                  class="hover:text-[var(--primary-color)] transition-all duration-300 flex items-center gap-1 group"
                >
                    <span class="group-hover:scale-110 transition-transform">✥</span> @SOLLUNGOMAAMIOFFICIAL
                </a>
                <span class="opacity-30">•</span>
                <a 
                  href="/" 
                  class="hover:text-[var(--primary-color)] transition-all duration-300"
                >
                    SOLLUNGOMAAMI.COM
                </a>
            </div>
          </div>
          <img src="https://raw.githubusercontent.com/AkshayNarayananB/SollungoMaami/Narak11---Switch-to-Server-Side-Rendering/images/SM-NewLogo.png" 
               alt="Logo" class="w-16 h-16 md:w-24 md:h-24 rounded-2xl md:rounded-[2.5rem] shadow-xl ml-4 flex-shrink-0 border-2 border-[var(--primary-color-lighten)] dark:border-white/10" />
        </header>

        <section class="grid grid-cols-1 md:grid-cols-3 gap-4 md:gap-5 mb-10 md:mb-16 p-4 md:p-6 bg-[var(--primary-color-lighten)] dark:bg-[var(--primary-color)] rounded-[2rem] md:rounded-[3rem] border-2 border-[var(--primary-color)] shadow-inner">
          {spotlightPosts.map((post) => (
            <a href={`/posts/${post.id}`} class="bg-[var(--bg-color)] dark:bg-[var(--card-color)] rounded-[1.5rem] md:rounded-[2rem] p-4 md:p-5 border-2 border-[var(--primary-color)] dark:border-white/10 transition-all hover:shadow-xl hover:-translate-y-1 block h-full group">
               <span class="text-[10px] font-black text-[var(--primary-color)] uppercase tracking-widest mb-3 block truncate">{post.title}</span>
               <div class="overflow-hidden rounded-xl border border-[var(--primary-color-lighten)]">
                   <img src={post.image || post.cover} alt={post.title} class="w-full h-28 md:h-36 object-cover group-hover:scale-105 transition-transform duration-500" />
               </div>
               <p class="text-[11px] md:text-xs text-[var(--text-color)] opacity-70 mt-4 leading-relaxed line-clamp-2 md:line-clamp-3 italic">
                 {post.description}
               </p>
            </a>
          ))}
        </section>

        <div class="grid grid-cols-1 lg:grid-cols-3 gap-10 md:gap-14">
          
          <div class="lg:col-span-2">
            <div class="inline-flex items-center gap-2 bg-[var(--primary-color)] px-4 py-1.5 rounded-full mb-6 shadow-sm">
                <span class="text-[10px] md:text-xs font-black text-white tracking-[0.2em] uppercase">The Archives</span>
            </div>
            
            <div class="space-y-3 md:space-y-4">
              {archives.map((post) => (
                <a href={`/posts/${post.id}`} class="flex items-center gap-4 p-3 bg-[var(--card-color)] rounded-2xl border border-[var(--primary-color-lighten)] hover:border-[var(--primary-color)] transition-all group">
                  <img src={post.image || post.cover} class="w-12 h-12 md:w-16 md:h-16 rounded-xl object-cover shadow-sm group-hover:rotate-2 transition-transform" />
                  <div class="flex-1 min-w-0">
                    <h3 class="font-black text-[var(--text-color)] uppercase text-[11px] md:text-sm truncate opacity-90">{post.title}</h3>
                    <p class="text-[10px] md:text-xs text-[var(--text-color)] opacity-50 truncate">{post.description}</p>
                  </div>
                  <span class="text-[var(--primary-color)] text-xl pr-2 transition-transform group-hover:translate-x-1">&rarr;</span>
                </a>
              ))}
            </div>
          </div>

          <aside class="space-y-10 md:space-y-14">
            <div>
              <p class="text-[10px] font-black opacity-30 tracking-widest mb-3 uppercase text-[var(--text-color)]">Received Mail</p>
              <div class="bg-[var(--card-color)] p-6 border-2 border-[var(--primary-color-lighten)] rounded-2xl shadow-sm border-l-4 border-[var(--primary-color)] relative">
                <span class="absolute -top-3 -left-2 text-2xl text-[var(--primary-color)] opacity-40 italic font-serif">"</span>
                <p class="text-xs md:text-sm text-[var(--text-color)] font-serif leading-relaxed opacity-90">
                    {meta.viewers_note_text}
                </p>
                <p class="mt-4 pt-4 border-t border-[var(--primary-color-lighten)] text-[10px] font-black tracking-wider uppercase text-[var(--primary-color)]">
                    — {meta.viewers_note_author}
                </p>
              </div>
            </div>

            <div class="bg-[var(--card-color)] border-2 border-[var(--primary-color-lighten)] p-8 rounded-3xl text-center shadow-sm hover:shadow-md transition-shadow">
                <h4 class="text-[10px] font-black text-[var(--primary-color)] tracking-[0.3em] mb-4 uppercase">Maami's Tips</h4>
                {meta.amateur_icon && <img src={meta.amateur_icon} class="w-12 h-12 mx-auto mb-4 object-contain filter drop-shadow-sm" />}
                <p class="text-xs font-black uppercase text-[var(--text-color)] mb-2 leading-tight px-2">{meta.amateur_title}</p>
                <p class="text-[10px] text-[var(--text-color)] opacity-60 leading-relaxed italic px-2">"{meta.amateur_description}"</p>
            </div>
          </aside>
        </div>

        <footer class="mt-20 pt-10 border-t border-[var(--primary-color-lighten)] text-center opacity-30 text-[9px] md:text-[11px] uppercase tracking-[0.3em] text-[var(--text-color)]">
            <p>&copy; 2026 Maami's Digest. Celebrating the beauty of simply being.</p>
        </footer>
      </>
    )}
  </div>
</Main>

<style>
    .font-serif { font-family: Georgia, 'Times New Roman', Times, serif; }
</style>
