---
export const prerender = false;

import { db } from '../../lib/firebase';
import { doc, getDoc } from 'firebase/firestore';
import PostLayout from "../../layouts/PostLayout.astro";
import LiveComments from "../../components/LiveComments.jsx";

// 1. COMMENT OUT MARKDOWN (To isolate the crash)
// import { marked } from 'marked';
// import DOMPurify from 'isomorphic-dompurify';

const { slug } = Astro.params;
if (!slug) return Astro.redirect('/404');

const docRef = doc(db, "blog", slug);
const docSnap = await getDoc(docRef);

if (!docSnap.exists()) return Astro.redirect('/404');
const post = docSnap.data();

// 2. SAFE DATE HANDLING
let publishedDate = new Date();
try {
  if (post.publishedAt && typeof post.publishedAt.toDate === 'function') {
    publishedDate = post.publishedAt.toDate();
  }
} catch (e) {
  console.log("Date error", e);
}

// 3. SAFE CATEGORY HANDLING (Array vs String)
const categoryDisplay = Array.isArray(post.category) 
  ? post.category[0] // If array, take first item
  : post.category;   // If string, use as is

const rawContent = post.content || "No content found.";
const tags = Array.isArray(post.tags) ? post.tags : [];
const bannerImageProp = post.licenseName ? post.cover : post.image;
---

<PostLayout
  title={post.title || "Untitled"}
  subTitle={post.description}
  bannerImage={bannerImageProp}
  published={publishedDate}
  author={post.author || "Sollungo Maami"}
>
  
  {/* Category Pill - NOW SAFE FOR ARRAYS */}
  <div class="mb-6">
    {categoryDisplay && (
      <span class="inline-block bg-amber-100 text-amber-800 text-xs px-2 py-1 rounded-md font-bold uppercase tracking-wider mb-2">
        {categoryDisplay}
      </span>
    )}

    {/* Tags Row */}
    {tags.length > 0 && (
      <div class="flex flex-wrap gap-2 mt-2">
        {tags.map((tag) => (
          <span class="text-sm text-gray-500 dark:text-gray-400 italic">
            #{tag}
          </span>
        ))}
      </div>
    )}
  </div>

  {/* RAW CONTENT (No Marked) */}
  {/* If this loads, we know the database connection is perfect. */}
  <div class="prose prose-lg dark:prose-invert max-w-none whitespace-pre-wrap">
    {rawContent}
  </div>

  <section class="mt-10">
    <LiveComments slug={slug} client:visible />
  </section>

</PostLayout>
