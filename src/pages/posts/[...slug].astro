---
export const prerender = false;

import { db } from '../../lib/firebase';
import { doc, getDoc } from 'firebase/firestore';
import PostLayout from "../../layouts/PostLayout.astro";
import LiveComments from "../../components/LiveComments.jsx";
import { marked } from 'marked';

const { slug } = Astro.params;
if (!slug) return Astro.redirect('/404');

const docRef = doc(db, "blog", slug);
const docSnap = await getDoc(docRef);

if (!docSnap.exists()) return Astro.redirect('/404');
const post = docSnap.data();

// --- 1. DATE HANDLING ---
let publishedDate = new Date();
try {
  if (post.publishedAt && typeof post.publishedAt.toDate === 'function') {
    publishedDate = post.publishedAt.toDate();
  }
} catch (e) {
  console.log("Date error", e);
}

// --- 2. CATEGORY HANDLING ---
const categoryDisplay = Array.isArray(post.category) 
  ? post.category[0] 
  : post.category;

let rawContent = post.content || "";

// --- FIX: HEADER PADDING ---
// 1. Find the hashes (e.g. '###') at start of line
// 2. Consume any existing spaces (\s*)
// 3. Replace with: Hash + Real Space + &nbsp; + The Title
rawContent = rawContent.replace(/^(#+)\s*(.*)/gm, '$1 &nbsp;$2');

// Optional: Ensure newline before headers
rawContent = rawContent.replace(/^(#+)/gm, '\n$1');
// -----------------------------------

let htmlContent = "";

try {
  // Force await in case marked returns a Promise
  const parsed = await marked.parse(rawContent);
  htmlContent = parsed;
} catch (e) {
  console.error("Marked Error:", e);
  htmlContent = "<p>Error rendering markdown.</p>";
}

const tags = Array.isArray(post.tags) ? post.tags : [];
const bannerImageProp = post.licenseName ? post.cover : post.image;

// 4. License Logic
const licenseProp = post.licenseName
  ? { name: post.licenseName, url: post.licenseUrl }
  : undefined;
---

<PostLayout
  title={post.title || "Untitled"}
  subTitle={post.description}
  bannerImage={bannerImageProp}
  published={publishedDate}
  license={licenseProp}
  author={post.author || "Sollungo Maami"}
  sourceLink={post.sourceLink}
>
  
  <div class="hidden" data-pagefind-body data-pagefind-weight="10" data-pagefind-meta="title">
    {post.title}
  </div>

  {/* Category Pill */}
  <div class="mb-6">
    {categoryDisplay && (
      <span class="inline-block bg-amber-100 text-amber-800 text-xs px-2 py-1 rounded-md font-bold uppercase tracking-wider mb-2">
        {categoryDisplay}
      </span>
    )}

    {/* Tags Row */}
    {tags.length > 0 && (
      <div class="flex flex-wrap gap-2 mt-2">
        {tags.map((tag: string) => (
          <span class="text-sm text-gray-500 dark:text-gray-400 italic">
            #{tag}
          </span>
        ))}
      </div>
    )}
  </div>

  {/* RENDERED HTML */}
  <div data-pagefind-body>
    <div 
      class="prose prose-lg prose-amber dark:prose-invert max-w-none"
      set:html={htmlContent} 
    />
  </div>

  <section class="mt-10">
    <LiveComments slug={slug} client:visible />
  </section>

</PostLayout>
