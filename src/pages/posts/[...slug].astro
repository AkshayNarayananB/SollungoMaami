---
// 1. ENABLE LIVE MODE
export const prerender = false;

import { db } from '../../lib/firebase';
import { doc, getDoc } from 'firebase/firestore';
import { marked } from 'marked';
import DOMPurify from 'isomorphic-dompurify';

import PostLayout from "../../layouts/PostLayout.astro";
import LiveComments from "../../components/LiveComments.jsx";

// 2. Get the Slug from URL
const { slug } = Astro.params;
if (!slug) return Astro.redirect('/404');

// 3. Fetch from Firebase
const docRef = doc(db, "blog", slug);
const docSnap = await getDoc(docRef);

if (!docSnap.exists()) return Astro.redirect('/404');
const post = docSnap.data();

// 4. PREPARE CONTENT (This replaces <Content />)
// We convert the raw Markdown string from Firebase into safe HTML
const rawHTML = marked.parse(post.content || "");
const cleanHTML = DOMPurify.sanitize(rawHTML);

// 5. Logic for License & Banner (Copied from your original file)
const licenseProp = post.licenseName
  ? { name: post.licenseName, url: post.licenseUrl }
  : undefined;

const bannerImageProp = post.licenseName ? post.cover : post.image;
const publishedDate = post.published ? post.published.toDate() : new Date();
---

<PostLayout
  title={post.title}
  subTitle={post.description}
  bannerImage={bannerImageProp}
  published={publishedDate}
  license={licenseProp}
  author={post.author || "Sollungo Maami"}
  sourceLink={post.sourceLink}
>
  
  {/* HIDDEN META FOR SEARCH (Kept from your original) */}
  <div class="hidden" data-pagefind-body data-pagefind-weight="10" data-pagefind-meta="title">
    {post.title}
  </div>

  {/* --- HERE IS THE BLOG CONTENT --- */}
  {/* In static, you used <Content />. 
      In dynamic, we use this div with set:html to inject the converted text. */}
  <div data-pagefind-body>
    <div 
      class="prose prose-lg prose-amber dark:prose-invert max-w-none"
      set:html={cleanHTML} 
    />
  </div>

  {/* COMMENTS SECTION */}
  <section class="mt-10">
    <LiveComments slug={slug} client:visible />
  </section>

</PostLayout>
