---
export const prerender = false;

import Main from "../../layouts/MainLayout.astro";
import RouteCard from "../../components/RouteCard.astro";
import Pagination from "../../components/controllers/Pagination.astro";

// Firebase Client SDK
import { db } from '../../lib/firebase';
import { collection, getDocs, query, orderBy, limit } from 'firebase/firestore';

const { page: pageParam } = Astro.params;
const currentPage = pageParam ? parseInt(pageParam, 10) : 1;
const pageSize = 6;

// 1. Fetch Routes (Ordered by published date)
const routeCol = collection(db, "route");
const routeQuery = query(routeCol, orderBy("published", "desc"));
const routeSnapshot = await getDocs(routeQuery);
const allRouteDocs = routeSnapshot.docs;

// 2. Fetch Blog Posts for Sidebar compatibility
const blogCol = collection(db, "blog");
const blogSnapshot = await getDocs(query(blogCol, orderBy("published", "desc"), limit(5)));
const allPosts = blogSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

// 3. Pagination Logic
const totalRoutes = allRouteDocs.length;
const lastPage = Math.max(1, Math.ceil(totalRoutes / pageSize));
const start = (currentPage - 1) * pageSize;
const end = start + pageSize;
const paginatedDocs = allRouteDocs.slice(start, end);

// 4. Map Data to Props
const formattedRoutes = paginatedDocs.map(doc => {
  const data = doc.data();
  return {
    id: doc.id,
    title: data.title,
    published: data.published?.toDate(), // Converts Firestore Timestamp to JS Date
    category: data.category,
    tags: data.tags || [],
    description: data.description,
    image: data.image,
    locationCount: data.locations ? data.locations.length : 0,
  };
});
---

<Main allPosts={allPosts}>
  <div class="space-y-8">
    
    {allRouteDocs.length === 0 && (
       <div class="p-4 bg-red-900/20 border border-red-900 text-red-400 rounded-2xl text-xs font-mono">
          Empty Collection: "route" | Project: {db.app.options.projectId}
       </div>
    )}

    <div class="w-full space-y-4">
      {formattedRoutes.map((entry, index) => (
        <div 
          class="onload-animation" 
          style={`animation-delay: calc(var(--onload-animation-delay) + ${index + 1} * var(--onload-animation-interval));`}
        >
          <RouteCard 
            id={entry.id}
            title={entry.title}
            published={entry.published}
            category={entry.category}
            tags={entry.tags}
            description={entry.description}
            image={entry.image}
            locationCount={entry.locationCount}
          />
        </div>
      ))}

      {totalRoutes === 0 && (
        <div class="py-20 text-center bg-[var(--card-color)] rounded-3xl opacity-50">
          <p>No routes found in the database.</p>
        </div>
      )}
    </div>

    {lastPage > 1 && (
      <Pagination
        lastPage={lastPage}
        current={currentPage}
        prevURL={currentPage > 1 ? (currentPage - 1 === 1 ? '/routes' : `/routes/${currentPage - 1}`) : undefined}
        nextURL={currentPage < lastPage ? `/routes/${currentPage + 1}` : undefined}
      />
    )}
  </div>
</Main>
