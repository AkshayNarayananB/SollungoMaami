---
export const prerender = false;

import Main from "../../layouts/MainLayout.astro";
import RouteCard from "../../components/RouteCard.astro";
import Pagination from "../../components/controllers/Pagination.astro";
import { db } from '../../lib/firebase';
import { collection, getDocs, query, limit } from 'firebase/firestore';

const { page: pageParam } = Astro.params;
const currentPage = pageParam ? parseInt(pageParam, 10) : 1;
const pageSize = 6;

// 1. Fetch Routes - REMOVED orderBy for testing
const q = query(collection(db, "route"), limit(20)); 
const querySnapshot = await getDocs(q);
const allDocs = querySnapshot.docs;

// 2. Fetch Blog Posts (to keep Sidebar happy)
const postQuery = query(collection(db, "blog"), limit(5));
const postSnapshot = await getDocs(postQuery);
const allPosts = postSnapshot.docs.map(doc => ({ id: doc.id, ...doc.data() }));

const totalRoutes = allDocs.length;
const lastPage = Math.max(1, Math.ceil(totalRoutes / pageSize));
const start = (currentPage - 1) * pageSize;
const end = start + pageSize;
const paginatedDocs = allDocs.slice(start, end);

// 3. Mapping with strict null checks
const formattedRoutes = paginatedDocs.map(doc => {
  const data = doc.data();
  return {
    id: doc.id,
    title: data.title || "Untitled Route",
    published: data.published?.toDate ? data.published.toDate() : new Date(),
    category: data.category || "Route",
    tags: data.tags || [],
    description: data.description || "",
    image: data.image || data.cover || "",
    locationCount: data.locations ? data.locations.length : 0,
  };
});
---

<Main allPosts={allPosts}>
  <div class="space-y-8">
    <div class="w-full space-y-4">
      {formattedRoutes.length > 0 ? (
        formattedRoutes.map((entry, index) => (
          <div class="onload-animation" style={`animation-delay: calc(var(--onload-animation-delay) + ${index + 1} * var(--onload-animation-interval));`}>
            <RouteCard {...entry} />
          </div>
        ))
      ) : (
        <div class="py-20 text-center bg-[var(--card-color)] rounded-3xl">
          <p class="text-[var(--text-color-lighten)]">No routes found. (Total Docs: {totalRoutes})</p>
        </div>
      )}
    </div>

    {lastPage > 1 && (
      <Pagination
        lastPage={lastPage}
        current={currentPage}
        prevURL={currentPage > 1 ? `/routes/${currentPage - 1}` : undefined}
        nextURL={currentPage < lastPage ? `/routes/${currentPage + 1}` : undefined}
      />
    )}
  </div>
</Main>
