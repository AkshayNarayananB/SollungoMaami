---
// 1. ENABLE LIVE MODE (SSR)
export const prerender = false;

import PostArchiveLayout from "../../layouts/PostArchiveLayout.astro";
import I18nKeys from "../../locales/keys";
import { i18n } from "../../locales/translation";

// Firebase Imports
import { db } from '../../lib/firebase';
import { collection, getDocs, query, orderBy } from 'firebase/firestore';

// 2. Utility to match slugs (e.g. "Gluten Free" -> "gluten-free")
const slugify = (text: string) => {
  return text
    .toString()
    .toLowerCase()
    .trim()
    .replace(/\s+/g, '-')
    .replace(/[^\w\-]+/g, '')
    .replace(/\-\-+/g, '-');
};

// 3. Get Tag from URL
const { tag } = Astro.params;

// Security: If no tag param, 404 immediately
if (!tag) {
  return Astro.redirect('/404');
}

// --- CACHE HEADERS ---
// Cache on Vercel (CDN) for 1 hour (3600s).
// Serve stale content for up to 10 mins (600s) while re-fetching in background.
Astro.response.headers.set(
  'Cache-Control', 
  'public, max-age=0, s-maxage=3600, stale-while-revalidate=600'
);
// ---------------------

// 4. Fetch ALL posts (Sorted by newest)
const q = query(collection(db, "blog"), orderBy("published", "desc"));
const querySnapshot = await getDocs(q);

const archiveMap = new Map();
let tagDisplayName = "";

// 5. Filter and Group Posts
querySnapshot.docs.forEach((doc) => {
  const data = doc.data();
  
  // Skip if post has no tags
  if (!data.tags || !Array.isArray(data.tags)) return;

  // Check if ANY of the tags on this post match the URL param
  const hasMatchingTag = data.tags.some((t) => {
    const slugifiedTag = slugify(t);
    if (slugifiedTag === tag) {
      // Capture the nice display name (e.g., "Gluten Free") from the match
      if (!tagDisplayName) tagDisplayName = t;
      return true;
    }
    return false;
  });
  
  if (hasMatchingTag) {
    const date = data.published ? data.published.toDate() : new Date();
    const year = date.getFullYear();

    // Construct the entry object for Layout
    const entry = {
      id: doc.id, // Using just ID, usually handled by Layout to form link
      data: {
        title: data.title,
        published: date,
        description: data.description,
        image: data.image,
        category: data.category,
        tags: data.tags || [],
      },
      slug: doc.id
    };

    // Add to Map
    if (!archiveMap.has(year)) {
      archiveMap.set(year, []);
    }
    archiveMap.get(year).push(entry);
  }
});

// 6. THE SECURITY CHECK (Add this!)
// If we looped through all posts and found NOTHING for this tag, 
// then this is not a valid tag page. Redirect to 404.
if (archiveMap.size === 0) {
  return Astro.redirect('/404');
}

---

<PostArchiveLayout
  archiveMap={archiveMap}
  title={tagDisplayName}
  subTitle={i18n(I18nKeys.pages_tags_archive)}
/>
