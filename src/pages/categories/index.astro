---
// 1. ENABLE LIVE MODE (SSR)
export const prerender = false;

import ChipLayout from "../../layouts/ChipLayout.astro";
import I18nKeys from "../../locales/keys";
import { i18n } from "../../locales/translation";

// Firebase Imports
import { db } from '../../lib/firebase';
import { collection, getDocs } from 'firebase/firestore';

// 2. Utility to match slugs
const slugify = (text: string) => {
  return text
    .toString()
    .toLowerCase()
    .trim()
    .replace(/\s+/g, '-')
    .replace(/[^\w\-]+/g, '')
    .replace(/\-\-+/g, '-');
};

// 3. Fetch ALL posts to aggregate categories
const querySnapshot = await getDocs(collection(db, "blog"));

// 4. Aggregate Counts
// Map format: { "Recipe": 5, "Travel": 2 }
const categoryCounts: Record<string, number> = {};

querySnapshot.docs.forEach((doc) => {
  const data = doc.data();
  if (data.category) {
    const cat = data.category.trim();
    categoryCounts[cat] = (categoryCounts[cat] || 0) + 1;
  }
});

// 5. Convert to Chips Array
const chips = Object.keys(categoryCounts)
  .sort() // Sort alphabetically
  .map((catName) => {
    return {
      name: catName,
      slug: slugify(catName), // Generate link (e.g. /categories/air-fryer)
      subChip: categoryCounts[catName].toString(), // The count
    };
  });
---

<ChipLayout chips={chips} title={i18n(I18nKeys.pages_categories_title)} />
