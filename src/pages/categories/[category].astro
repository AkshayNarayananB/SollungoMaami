---
// 1. ENABLE LIVE MODE (SSR)
export const prerender = false;

import PostArchiveLayout from "../../layouts/PostArchiveLayout.astro";
import I18nKeys from "../../locales/keys";
import { i18n } from "../../locales/translation";

// Firebase Imports
import { db } from '../../lib/firebase';
import { collection, getDocs, query, orderBy } from 'firebase/firestore';

// 2. Utility to match slugs (e.g. "Air Fryer" -> "air-fryer")
const slugify = (text: string) => {
  return text
    .toString()
    .toLowerCase()
    .trim()
    .replace(/\s+/g, '-')     // Replace spaces with -
    .replace(/[^\w\-]+/g, '') // Remove all non-word chars
    .replace(/\-\-+/g, '-');  // Replace multiple - with single -
};

// 3. Get Category from URL
const { category } = Astro.params;
if (!category) {
  return Astro.redirect('/404');
}

// --- CACHE HEADERS ---
// Cache on Vercel (CDN) for 1 hour (3600s).
// Serve stale content for up to 10 mins (600s) while re-fetching in background.
Astro.response.headers.set(
  'Cache-Control', 
  'public, max-age=0, s-maxage=3600, stale-while-revalidate=600'
);
// ---------------------

// 4. Fetch ALL posts (Sorted by newest)
// We fetch all to filter in JS, which ensures case-insensitive slug matching
const q = query(collection(db, "blog"), orderBy("published", "desc"));
const querySnapshot = await getDocs(q);

const archiveMap = new Map();
let categoryDisplayName = "";

// 5. Filter and Group Posts
querySnapshot.docs.forEach((doc) => {
  const data = doc.data();
  
  // Skip if post has no category
  if (!data.category) return;

  // Check if this post belongs to the requested category slug
  const postCategorySlug = slugify(data.category);
  
  if (postCategorySlug === category) {
    // Capture the nice display name (e.g., "Recipe") from the first match
    if (!categoryDisplayName) categoryDisplayName = data.category;

    const date = data.published ? data.published.toDate() : new Date();
    const year = date.getFullYear();

    // Construct the entry object for Layout
    const entry = {
      id: `/posts/${doc.id}`,
      title: data.title,
      date: date,
      tags: data.tags || [],
    };

    // Add to Map
    if (!archiveMap.has(year)) {
      archiveMap.set(year, []);
    }
    archiveMap.get(year).push(entry);
  }
});

if (archiveMap.size === 0) {
  return Astro.redirect('/404');
} 

// If no category name was found (meaning no posts matched), fallback to URL param
if (!categoryDisplayName) {
  categoryDisplayName = category || "Unknown Category";
}
---

<PostArchiveLayout
  archiveMap={archiveMap}
  title={categoryDisplayName}
  subTitle={i18n(I18nKeys.pages_categories_archive)}
/>
