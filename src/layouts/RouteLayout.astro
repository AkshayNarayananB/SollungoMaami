---
import Main from "../layouts/MainLayout.astro";
import Markdown from "../components/Markdown.astro";

interface Location {
  lat: number;
  lng: number;
  label: string;
  url: string;
}

interface Props {
  title: string;
  category: string;
  tags: string[];
  locations: Location[];
  googleMapsUrl: string;
}

const { title, category, tags, locations, googleMapsUrl } = Astro.props;
---

<Main title={title}>
  <link 
    rel="stylesheet" 
    href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" 
    integrity="sha256-p4NxAoJBhIIN+hmNHrzRCf9tD/miZyoHS5obTRR9BMY=" 
    crossorigin=""
  />

  <div class="route-wrapper" data-pagefind-ignore>
    <header class="mb-6">
      <h1 class="text-3xl font-bold mb-2 text-[var(--text-color)]">{title}</h1>
      <div class="flex gap-2 items-center text-sm opacity-70">
        <span class="bg-[var(--primary-color-lighten)] text-[var(--primary-color)] px-2 py-1 rounded">{category}</span>
        {tags.map(tag => <span class="border border-[var(--primary-color-lighten)] px-2 py-1 rounded text-[var(--text-color)]">#{tag}</span>)}
      </div>
    </header>

    <div id="map" class="map-window"></div>

    <div class="my-6 text-center">
      <a 
        href={googleMapsUrl} 
        target="_blank" 
        rel="noopener noreferrer"
        class="route-button"
      >
        <span class="icon">üìç</span> Open Live Route in Google Maps
      </a>
    </div>

    <div class="article-wrapper">
      <div class="article">
        <Markdown>
          <slot />
        </Markdown>
      </div>
    </div>
  </div>
</Main>

<script is:inline src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>

<script is:inline define:vars={{ locations }}>
  function initMap() {
    if (typeof L === 'undefined' || !locations || locations.length === 0) return;

    // Initialize map
    const map = L.map('map').setView([locations[0].lat, locations[0].lng], 12);

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    // Add Markers
    locations.forEach(loc => {
      const marker = L.marker([loc.lat, loc.lng]).addTo(map);
      
      marker.bindPopup(`
        <div style="text-align:center; color: black !important;">
          <p style="margin: 0; font-weight: bold;">${loc.label}</p>
          <a href="${loc.url}" style="color: #2563eb; text-decoration: underline; font-size: 12px;">View Details</a>
        </div>
      `);
    });

    // Adjust zoom to fit all markers
    if (locations.length > 1) {
      const group = new L.featureGroup(locations.map(l => L.marker([l.lat, l.lng])));
      map.fitBounds(group.getBounds().pad(0.1));
    }
  }

  // Handle both standard loads and Astro view transitions
  document.addEventListener('DOMContentLoaded', initMap);
  document.addEventListener('astro:page-load', initMap);
</script>

<style>
  .route-wrapper {
    @apply max-w-5xl mx-auto px-4 py-8;
  }
  .map-window {
    height: 450px;
    width: 100%;
    @apply rounded-3xl border-4 border-[var(--card-color)] shadow-xl;
    z-index: 1; /* Keeps map below navbar dropdowns */
  }
  .route-button {
    @apply inline-flex items-center gap-2 bg-blue-600 hover:bg-blue-700 text-white font-bold py-3 px-8 rounded-full transition-all shadow-lg hover:scale-105 active:scale-95;
  }
  .article-wrapper {
    @apply rounded-3xl bg-[var(--card-color)] px-6 py-8 lg:px-12 lg:py-10;
  }
  .article {
    @apply flex flex-col text-[var(--text-color)];
    font-family: var(--primary-font);
  }
  /* Fix for Leaflet controls in dark mode */
  :global(.leaflet-control-zoom-in), :global(.leaflet-control-zoom-out) {
    background: white !important;
    color: black !important;
  }
</style>
