---
import Main from "../layouts/MainLayout.astro";
import Markdown from "../components/Markdown.astro";

interface Location {
  lat: number;
  lng: number;
  label: string;
  url: string;
}

interface Props {
  title: string;
  category: string;
  tags: string[];
  locations: Location[];
  googleMapsUrl: string;
}

const { title, category, tags, locations, googleMapsUrl } = Astro.props;
---

<Main title={title}>
  <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
  <link rel="stylesheet" href="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.css" />

  <div class="route-wrapper" data-pagefind-ignore>
    <header class="mb-6">
      <h1 class="text-3xl font-bold mb-2 text-[var(--text-color)]">{title}</h1>
      <div class="flex gap-2 items-center text-sm opacity-70">
        <span class="bg-[var(--primary-color-lighten)] text-[var(--primary-color)] px-2 py-1 rounded">{category}</span>
        {tags.map(tag => <span class="border border-[var(--primary-color-lighten)] px-2 py-1 rounded text-[var(--text-color)]">#{tag}</span>)}
      </div>
    </header>

    <div id="route-stats" class="mb-4 flex gap-4 justify-center md:justify-start">
        <div class="stat-card">
            <span class="text-xs uppercase opacity-60 font-bold">Total Distance</span>
            <p id="total-dist" class="text-lg font-bold text-orange-500">Calculating...</p>
        </div>
        <div class="stat-card">
            <span class="text-xs uppercase opacity-60 font-bold">Travel Time</span>
            <p id="total-time" class="text-lg font-bold text-orange-500">...</p>
        </div>
    </div>

    <div id="map" class="map-window"></div>

    <div class="my-6 text-center">
      <a 
        href={googleMapsUrl} 
        target="_blank" 
        rel="noopener noreferrer"
        class="route-button"
      >
        <span class="icon">üìç</span> Open Live Route in Google Maps
      </a>
    </div>

    <div class="article-wrapper">
      <div class="article">
        <Markdown>
          <slot />
        </Markdown>
      </div>
    </div>
  </div>
</Main>

<script is:inline src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
<script is:inline src="https://unpkg.com/leaflet-routing-machine@3.2.12/dist/leaflet-routing-machine.js"></script>

<script is:inline define:vars={{ locations }}>
  function destroyMap() {
    if (window.currentLeafletMap) {
        window.currentLeafletMap.remove();
        window.currentLeafletMap = null;
    }
    const container = document.getElementById('map');
    if (container) {
        container.innerHTML = '';
        delete container._leaflet_id;
    }
  }

  function initMap() {
    destroyMap(); 

    const mapContainer = document.getElementById('map');
    if (!mapContainer || typeof L === 'undefined' || !locations || locations.length === 0) return;

    const map = L.map('map').setView([locations[0].lat, locations[0].lng], 12);
    window.currentLeafletMap = map; 

    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: '¬© OpenStreetMap contributors'
    }).addTo(map);

    const waypoints = locations.map(loc => L.latLng(loc.lat, loc.lng));

    const routingControl = L.Routing.control({
      waypoints: waypoints,
      router: L.Routing.osrmv1({
        serviceUrl: 'https://router.project-osrm.org/route/v1',
        profile: 'car',
        useHints: false 
      }),
      lineOptions: {
        styles: [{ color: '#ff8c00', opacity: 0.9, weight: 6 }],
        addWaypoints: false
      },
      routeWhileDragging: false,
      draggableWaypoints: false,
      fitSelectedRoutes: true,
      show: false,
      createMarker: function(i, waypoint) {
        const loc = locations[i];
        return L.marker(waypoint.latLng).bindPopup(`
          <div style="text-align:center; color: black !important; min-width: 100px;">
            <p style="margin: 0; font-weight: bold;">${loc.label}</p>
            <a href="${loc.url}" style="color: #2563eb; text-decoration: underline; font-size: 11px;">View Details</a>
          </div>
        `);
      }
    }).addTo(map);

    routingControl.on('routesfound', function(e) {
      const summary = e.routes[0].summary;
      const distance = (summary.totalDistance / 1000).toFixed(1);
      const totalSeconds = summary.totalTime;
      const hours = Math.floor(totalSeconds / 3600);
      const minutes = Math.floor((totalSeconds % 3600) / 60);
      
      const distEl = document.getElementById('total-dist');
      const timeEl = document.getElementById('total-time');

      if (distEl) distEl.innerText = `${distance} km`;
      if (timeEl) timeEl.innerText = hours > 0 ? `${hours}h ${minutes}m` : `${minutes}m`;
    });
  }

  document.addEventListener('DOMContentLoaded', initMap);
  document.addEventListener('astro:after-swap', initMap);
  document.addEventListener('astro:page-load', initMap);
</script>

<style>
  .route-wrapper {
    @apply max-w-5xl mx-auto px-4 py-8;
  }
  .map-window {
    height: 450px;
    width: 100%;
    @apply rounded-3xl border-4 border-[var(--card-color)] shadow-xl;
    position: relative;
    overflow: hidden;
  }
  .stat-card {
    @apply bg-[var(--card-color)] border border-white/5 px-6 py-3 rounded-2xl shadow-sm min-w-[140px];
  }
  .route-button {
    @apply inline-flex items-center gap-2 bg-orange-500 hover:bg-orange-600 text-white font-bold py-3 px-8 rounded-full transition-all shadow-lg hover:scale-105 active:scale-95;
  }
  .article-wrapper {
    @apply rounded-3xl bg-[var(--card-color)] px-6 py-8 lg:px-12 lg:py-10 mt-8;
  }
  .article {
    @apply flex flex-col text-[var(--text-color)];
    font-family: var(--primary-font);
  }
  :global(.leaflet-routing-container) {
    display: none !important;
  }
</style>
